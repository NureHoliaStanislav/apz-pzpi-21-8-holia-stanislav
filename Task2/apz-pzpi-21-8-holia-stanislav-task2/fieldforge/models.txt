class TrainingResultsView(generics.RetrieveAPIView):
    permission_classes = (IsAuthenticated,)
    serializer_class = ResultsSerializer
    queryset = Training.objects.all()
    lookup_field = 'uuid'

    def retrieve(self, request, *args, **kwargs):
        instance = self.get_object().results
        serializer = self.get_serializer(instance)
        response_data = serializer.data
        # Calculate the success percentage
        total_mines = instance.mines_activated + instance.mines_passed + instance.mines_defused
        if total_mines == 0:
            success_percentage = 0
        else:
            success_percentage = ((instance.mines_defused + instance.mines_passed) / total_mines) * 100

        # Subtract the ratio of soldiers_lost to total_mines from success_percentage
        if instance.soldiers_lost > 0 and total_mines > 0:
            success_percentage -= (instance.soldiers_lost / total_mines) * 100

        # Ensure success_percentage doesn't fall below 0
        success_percentage = max(success_percentage, 0)

        return Response({
            'results': response_data,
            'success_percentage': success_percentage
        })
